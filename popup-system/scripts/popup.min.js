/*! Mode Popup v1.0 | (c) 2025 Mode | Production Build */
!function(){"use strict";const CONFIG={API_BASE:"https://mode-dash-production.up.railway.app/api",POPUP_ID:"mode-popup-container",OVERLAY_ID:"mode-popup-overlay",STORAGE_KEY:"mode_popup_session",DEFAULT_FREQUENCY:"session",DEFAULT_PLACEMENT:"thankyou",ANIMATION_DURATION:300,ROTATION_DELAY:15e3,MOBILE_BREAKPOINT:768};class ModePopup{constructor(){this.campaigns=[],this.currentCampaignIndex=0,this.config={},this.isVisible=!1,this.autoRotateTimer=null,this.sessionId=this.generateSessionId()}async init(t={}){if(this.config={property:t.property||"mff",placement:t.placement||CONFIG.DEFAULT_PLACEMENT,frequency:t.frequency||CONFIG.DEFAULT_FREQUENCY,debug:t.debug||!1,autoRotate:!1!==t.autoRotate,...t},this.debug("Initializing Mode Popup",this.config),this.shouldShowPopup())try{if(await this.loadCampaigns(),0===this.campaigns.length)return void this.debug("No active campaigns found");this.handlePlacement()}catch(t){this.debug("Error initializing popup:",t)}else this.debug("Popup frequency check failed, not showing")}async loadCampaigns(){try{const t=await fetch(`${CONFIG.API_BASE}/campaigns/active/${this.config.property}`);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const e=await t.json();this.campaigns=e.campaigns||[],this.debug(`Loaded ${this.campaigns.length} campaigns for ${this.config.property}`)}catch(t){this.debug("Failed to load campaigns:",t),this.campaigns=[]}}handlePlacement(){switch(this.config.placement){case"thankyou":this.showPopup();break;case"exit-intent":this.setupExitIntent();break;case"timed":setTimeout((()=>this.showPopup()),3e3);break;default:this.showPopup()}}setupExitIntent(){let t=!1;const e=e=>{e.clientY<=50&&!t&&(t=!0,this.showPopup(),document.removeEventListener("mouseleave",e))};document.addEventListener("mouseleave",e)}shouldShowPopup(){const t=`${CONFIG.STORAGE_KEY}_${this.config.property}`,e=localStorage.getItem(t);if(!e)return!0;const o=new Date(e),n=new Date;switch(this.config.frequency){case"always":return!0;case"daily":return n.toDateString()!==o.toDateString();case"session":default:return!1}}markPopupShown(){const t=`${CONFIG.STORAGE_KEY}_${this.config.property}`;localStorage.setItem(t,(new Date).toISOString())}showPopup(){this.isVisible||0===this.campaigns.length||(this.createPopupHTML(),this.isVisible=!0,this.markPopupShown(),this.trackImpression(),this.config.autoRotate&&this.campaigns.length>1&&this.startAutoRotation(),this.debug("Popup shown"))}createPopupHTML(){this.removePopup();const t=this.campaigns[this.currentCampaignIndex],e=document.createElement("div");e.id=CONFIG.OVERLAY_ID,e.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 300ms ease;padding:16px;box-sizing:border-box;";const o=document.createElement("div");o.id=CONFIG.POPUP_ID,o.style.cssText="max-width:340px;width:100%;background:white;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,0.2);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow:hidden;position:relative;transform:scale(0.8);transition:transform 300ms ease;margin:0 auto;",o.innerHTML=this.getPopupHTML(t),e.appendChild(o),document.body.appendChild(e),requestAnimationFrame((()=>{e.style.opacity="1",o.style.transform="scale(1)"})),this.attachEventListeners(e,o,t)}getPopupHTML(t){const e=window.innerWidth<CONFIG.MOBILE_BREAKPOINT?"width: 260px; height: 200px;":"width: 280px; height: 220px;";return`<button class="mode-popup-close" style="position:absolute;top:16px;right:16px;background:rgba(0,0,0,0.1);border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:background 0.2s ease;" onmouseover="this.style.background='rgba(0,0,0,0.2)'" onmouseout="this.style.background='rgba(0,0,0,0.1)'"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M13 1L1 13M1 1L13 13" stroke="#666" stroke-width="2" stroke-linecap="round"/></svg></button><div style="position:absolute;top:24px;left:24px;width:56px;height:56px;background:transparent;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);"><img src="${t.logo_url||"https://via.placeholder.com/56/F7007C/FFFFFF?text=LOGO"}" alt="Logo" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.src='https://via.placeholder.com/56/F7007C/FFFFFF?text=LOGO'"></div><div style="padding:24px;padding-top:100px;text-align:center;"><div style="background:#F3F4F6;color:#6B7280;padding:6px 12px;border-radius:16px;font-size:12px;margin-bottom:24px;display:inline-block;font-weight:500;">Mode Financial Offers</div><h2 style="margin:0 0 8px 0;font-size:24px;font-weight:800;line-height:1.2;color:#111827;">${t.name||"Exclusive Offer"}</h2><div style="margin:16px 0;display:flex;align-items:center;justify-content:center;"><img src="${t.main_image_url||"https://via.placeholder.com/280x220/F7007C/FFFFFF?text=Offer"}" alt="Campaign" style="${e} object-fit:contain;object-position:center;border-radius:12px;background-color:#f8f9fa;" onerror="this.src='https://via.placeholder.com/280x220/F7007C/FFFFFF?text=Offer'"></div><p style="color:#6B7280;font-size:14px;line-height:1.4;margin:16px 0 24px 0;text-align:center;">${t.description||"Exclusive financial opportunity - limited time offer."}</p><button class="mode-popup-cta" style="width:100%;background:#7C3AED;color:white;border:none;padding:16px;border-radius:16px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:12px;transition:background 0.2s ease;" onmouseover="this.style.background='#6D28D9'" onmouseout="this.style.background='#7C3AED'">${t.cta_text||"View Offer"}</button>${this.campaigns.length>1?`<button class="mode-popup-next" style="width:100%;background:white;color:#6B7280;border:2px solid #E5E7EB;padding:14px;border-radius:16px;font-size:14px;font-weight:500;cursor:pointer;margin-bottom:16px;transition:all 0.2s ease;" onmouseover="this.style.borderColor='#D1D5DB';this.style.background='#F9FAFB'" onmouseout="this.style.borderColor='#E5E7EB';this.style.background='white'">Next ></button><div style="text-align:center;margin-bottom:16px;">${this.campaigns.map(((t,e)=>`<span style="width:8px;height:8px;background:${e===this.currentCampaignIndex?"#374151":"#D1D5DB"};border-radius:50%;margin:0 3px;display:inline-block;transition:background 0.2s ease;"></span>`)).join("")}</div>`:""}
<div style="color:#9CA3AF;font-size:11px;text-align:center;line-height:1.3;">T&Cs Apply | Powered by <strong>Mode</strong> â€¢ Privacy Policy</div></div>`}attachEventListeners(t,e,o){const n=e.querySelector(".mode-popup-close");n&&n.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),this.hidePopup()}));const s=e.querySelector(".mode-popup-cta");s&&s.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),this.handleCTAClick(o)}));const i=e.querySelector(".mode-popup-next");i&&i.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),this.nextCampaign()})),t.addEventListener("click",(e=>{e.target===t&&this.hidePopup()}));const r=t=>{
"Escape"===t.key&&(this.hidePopup(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r)}handleCTAClick(t){this.debug("CTA clicked",t),this.trackClick(t),t.tune_url&&window.open(t.tune_url,"_blank"),setTimeout((()=>this.hidePopup()),500)}nextCampaign(){this.campaigns.length<=1||(this.currentCampaignIndex=(this.currentCampaignIndex+1)%this.campaigns.length,this.updatePopupContent(),this.config.autoRotate&&this.resetAutoRotation(),this.debug(`Switched to campaign ${this.currentCampaignIndex+1}/${this.campaigns.length}`))}updatePopupContent(){const t=document.getElementById(CONFIG.POPUP_ID);if(!t)return;const e=this.campaigns[this.currentCampaignIndex];t.style.opacity="0.7",t.style.transform="scale(0.98)",setTimeout((()=>{t.innerHTML=this.getPopupHTML(e);const o=document.getElementById(CONFIG.OVERLAY_ID);this.attachEventListeners(o,t,e),t.style.opacity="1",t.style.transform="scale(1)",this.trackImpression()}),100)}startAutoRotation(){this.stopAutoRotation(),this.autoRotateTimer=setInterval((()=>{this.nextCampaign()}),CONFIG.ROTATION_DELAY)}stopAutoRotation(){this.autoRotateTimer&&(clearInterval(this.autoRotateTimer),this.autoRotateTimer=null)}resetAutoRotation(){this.config.autoRotate&&this.campaigns.length>1&&this.startAutoRotation()}hidePopup(){const t=document.getElementById(CONFIG.OVERLAY_ID),e=document.getElementById(CONFIG.POPUP_ID);t&&e&&(this.stopAutoRotation(),t.style.opacity="0",e.style.transform="scale(0.8)",setTimeout((()=>{this.removePopup(),this.isVisible=!1}),CONFIG.ANIMATION_DURATION),this.debug("Popup hidden"))}removePopup(){const t=document.getElementById(CONFIG.OVERLAY_ID);t&&t.remove()}async trackImpression(){const t=this.campaigns[this.currentCampaignIndex];if(!t)return;try{await fetch(`${CONFIG.API_BASE}/impression`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaign_id:t.id,property_code:this.config.property,session_id:this.sessionId,placement:this.config.placement,user_agent:navigator.userAgent,timestamp:(new Date).toISOString()})}),this.debug("Impression tracked",t)}catch(t){this.debug("Failed to track impression:",t)}}async trackClick(t){try{await fetch(`${CONFIG.API_BASE}/click`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({campaign_id:t.id,property_code:this.config.property,session_id:this.sessionId,placement:this.config.placement,user_agent:navigator.userAgent,timestamp:(new Date).toISOString()})}),this.debug("Click tracked",t.id)}catch(t){this.debug("Failed to track click:",t)}}generateSessionId(){return"mode_"+Date.now()+"_"+Math.random().toString(36).substring(2,15)}debug(...t){this.config.debug&&console.log("[ModePopup]",...t)}}window.ModePopup=new ModePopup,document.addEventListener("DOMContentLoaded",(()=>{const t=document.querySelector('script[src*="popup.js"]');if(t){const e=t.getAttribute("data-property"),o=t.getAttribute("data-placement"),n=t.getAttribute("data-frequency");e&&window.ModePopup.init({property:e,placement:o||"thankyou",frequency:n||"session"})}}))}(); 