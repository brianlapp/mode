<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Attribution Test - Mode Popup System</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-scenario {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #c41e3a;
        }
        
        .test-scenario h3 {
            margin-top: 0;
            color: #c41e3a;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .utm-display {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            margin: 15px 0;
            border-left: 3px solid #3b82f6;
        }
        
        .expected-result {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #22c55e;
        }
        
        .test-btn {
            background: #c41e3a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .test-btn:hover {
            background: #a31729;
            transform: translateY(-1px);
        }
        
        .results {
            background: #fef3c7;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            border-left: 3px solid #f59e0b;
        }
        
        .console-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-pending { background: #fbbf24; color: #92400e; }
        .status-success { background: #34d399; color: #065f46; }
        .status-error { background: #f87171; color: #991b1b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ UTM Attribution Test Suite</h1>
        <p>Testing UTM source to aff_sub3 parameter passing in Mode Popup System</p>
        <p><strong>Current URL:</strong> <span id="current-url"></span></p>
        <p><strong>Detected UTM Source:</strong> <span id="detected-source"></span></p>
    </div>

    <div class="test-scenario">
        <h3>üìò Test 1: Facebook Traffic Attribution</h3>
        <p>Simulates Facebook/Meta ads traffic with utm_source=facebook</p>
        <div class="utm-display">
            ?utm_source=facebook&utm_medium=cpc&utm_campaign=finance_lookalike
        </div>
        <div class="expected-result">
            <strong>Expected:</strong> Tune URL + <code>&aff_sub3=facebook</code>
        </div>
        <button class="test-btn" onclick="testAttribution('facebook', 'cpc', 'finance_lookalike')">
            Test Facebook Attribution
        </button>
        <span class="status-badge status-pending" id="status-facebook">Pending</span>
    </div>

    <div class="test-scenario">
        <h3>üîç Test 2: Google Traffic Attribution</h3>
        <p>Simulates Google organic/paid traffic with utm_source=google</p>
        <div class="utm-display">
            ?utm_source=google&utm_medium=organic&utm_campaign=trading_tips
        </div>
        <div class="expected-result">
            <strong>Expected:</strong> Tune URL + <code>&aff_sub3=google</code>
        </div>
        <button class="test-btn" onclick="testAttribution('google', 'organic', 'trading_tips')">
            Test Google Attribution
        </button>
        <span class="status-badge status-pending" id="status-google">Pending</span>
    </div>

    <div class="test-scenario">
        <h3>üìß Test 3: Email Traffic Attribution</h3>
        <p>Simulates email campaign traffic with utm_source=email</p>
        <div class="utm-display">
            ?utm_source=email&utm_medium=newsletter&utm_campaign=weekly_market
        </div>
        <div class="expected-result">
            <strong>Expected:</strong> Tune URL + <code>&aff_sub3=email</code>
        </div>
        <button class="test-btn" onclick="testAttribution('email', 'newsletter', 'weekly_market')">
            Test Email Attribution
        </button>
        <span class="status-badge status-pending" id="status-email">Pending</span>
    </div>

    <div class="test-scenario">
        <h3>üåê Test 4: Direct Traffic (No UTM)</h3>
        <p>Simulates direct traffic with no UTM parameters</p>
        <div class="utm-display">
            (No UTM parameters)
        </div>
        <div class="expected-result">
            <strong>Expected:</strong> Original Tune URL unchanged (no aff_sub3 added)
        </div>
        <button class="test-btn" onclick="testAttribution(null, null, null)">
            Test Direct Traffic
        </button>
        <span class="status-badge status-pending" id="status-direct">Pending</span>
    </div>

    <div class="test-scenario">
        <h3>üîí Test 5: Existing aff_sub3 Preservation</h3>
        <p>Test campaign that already has aff_sub3 parameter</p>
        <div class="utm-display">
            ?utm_source=facebook (with campaign having existing aff_sub3=existing)
        </div>
        <div class="expected-result">
            <strong>Expected:</strong> Preserve existing aff_sub3=existing (no overwrite)
        </div>
        <button class="test-btn" onclick="testExistingAffSub3()">
            Test Preservation
        </button>
        <span class="status-badge status-pending" id="status-preserve">Pending</span>
    </div>

    <div class="results" id="results" style="display: none;">
        <h3>üìä Test Results</h3>
        <div id="results-content"></div>
        <div class="console-output" id="console-output"></div>
    </div>

    <!-- Load Mode Popup Script -->
    <script src="popup.js"></script>

    <script>
        // Test Results Storage
        let testResults = [];
        let consoleMessages = [];
        
        // Override console.log to capture debug messages
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            consoleMessages.push(args.join(' '));
            updateConsoleOutput();
        };

        // Update current URL display
        document.getElementById('current-url').textContent = window.location.href;
        
        // Initialize popup and show detected source
        let modePopup;
        
        async function initializePopup() {
            try {
                modePopup = new ModePopup();
                await modePopup.init({ 
                    property: 'mff', 
                    debug: true,
                    frequency: 'always' 
                });
                
                // Show detected UTM source
                const detectedSource = modePopup.trackingData?.source || 'None detected';
                document.getElementById('detected-source').textContent = detectedSource;
                
                console.log('UTM Attribution Test: Popup initialized', modePopup.trackingData);
            } catch (error) {
                console.error('Failed to initialize popup:', error);
                document.getElementById('detected-source').textContent = 'Error initializing';
            }
        }

        // Test Attribution Function
        function testAttribution(source, medium, campaign) {
            if (!modePopup) {
                alert('Popup not initialized. Please refresh the page.');
                return;
            }

            // Create test tracking data
            const testTrackingData = {
                source: source,
                subsource: medium || 'popup',
                utm_campaign: campaign,
                referrer: document.referrer,
                landing_page: window.location.href
            };

            // Test sample campaign
            const testCampaign = {
                id: 1,
                name: 'Test Campaign - Trading Tips',
                tune_url: 'https://track.modemobile.com/aff_c?offer_id=6998&aff_id=43045&aff_sub5=popup_tradingTips'
            };

            try {
                // Test the buildAttributedTuneUrl method directly
                const attributedUrl = modePopup.buildAttributedTuneUrl(testCampaign.tune_url, testTrackingData);
                
                // Log results
                const testResult = {
                    scenario: getScenarioName(source),
                    originalUrl: testCampaign.tune_url,
                    attributedUrl: attributedUrl,
                    utmSource: source,
                    success: true,
                    hasAttribution: attributedUrl.includes('aff_sub3=')
                };

                testResults.push(testResult);
                updateTestStatus(source, true);
                showResults();

                console.log(`‚úÖ Attribution Test: ${testResult.scenario}`, testResult);
                
            } catch (error) {
                const testResult = {
                    scenario: getScenarioName(source),
                    error: error.message,
                    success: false
                };
                
                testResults.push(testResult);
                updateTestStatus(source, false);
                showResults();
                
                console.error(`‚ùå Attribution Test Failed: ${testResult.scenario}`, error);
            }
        }

        // Test existing aff_sub3 preservation
        function testExistingAffSub3() {
            if (!modePopup) {
                alert('Popup not initialized. Please refresh the page.');
                return;
            }

            const testTrackingData = {
                source: 'facebook',
                subsource: 'cpc',
                utm_campaign: 'test_campaign',
                referrer: document.referrer,
                landing_page: window.location.href
            };

            // Campaign with existing aff_sub3
            const testCampaign = {
                id: 1,
                name: 'Test Campaign with Existing aff_sub3',
                tune_url: 'https://track.modemobile.com/aff_c?offer_id=6998&aff_id=43045&aff_sub3=existing'
            };

            try {
                const attributedUrl = modePopup.buildAttributedTuneUrl(testCampaign.tune_url, testTrackingData);
                
                const testResult = {
                    scenario: 'Existing aff_sub3 Preservation',
                    originalUrl: testCampaign.tune_url,
                    attributedUrl: attributedUrl,
                    utmSource: 'facebook',
                    success: true,
                    preservedExisting: attributedUrl.includes('aff_sub3=existing')
                };

                testResults.push(testResult);
                updateTestStatus('preserve', testResult.preservedExisting);
                showResults();

                console.log('‚úÖ Preservation Test:', testResult);
                
            } catch (error) {
                updateTestStatus('preserve', false);
                console.error('‚ùå Preservation Test Failed:', error);
            }
        }

        // Helper Functions
        function getScenarioName(source) {
            const scenarios = {
                'facebook': 'Facebook Traffic',
                'google': 'Google Traffic', 
                'email': 'Email Traffic',
                null: 'Direct Traffic'
            };
            return scenarios[source] || 'Unknown';
        }

        function updateTestStatus(source, success) {
            const statusMap = {
                'facebook': 'status-facebook',
                'google': 'status-google',
                'email': 'status-email',
                null: 'status-direct',
                'preserve': 'status-preserve'
            };
            
            const statusElement = document.getElementById(statusMap[source]);
            if (statusElement) {
                statusElement.className = `status-badge ${success ? 'status-success' : 'status-error'}`;
                statusElement.textContent = success ? 'Success' : 'Failed';
            }
        }

        function showResults() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            let html = '<h4>Attribution Test Results:</h4>';
            
            testResults.forEach(result => {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: ${result.success ? '#f0fdf4' : '#fef2f2'}; border-radius: 6px;">
                        <strong>${result.scenario}:</strong><br>
                        ${result.success ? 
                            `‚úÖ Success<br>
                             <strong>Original:</strong> ${result.originalUrl}<br>
                             <strong>Attributed:</strong> ${result.attributedUrl}<br>
                             <strong>Has Attribution:</strong> ${result.hasAttribution ? 'Yes' : 'No'}
                             ${result.preservedExisting !== undefined ? `<br><strong>Preserved Existing:</strong> ${result.preservedExisting ? 'Yes' : 'No'}` : ''}` :
                            `‚ùå Failed: ${result.error}`
                        }
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function updateConsoleOutput() {
            const consoleOutput = document.getElementById('console-output');
            consoleOutput.innerHTML = consoleMessages.slice(-20).join('<br>');
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Initialize on page load
        window.addEventListener('load', initializePopup);

        // Test All Button
        function runAllTests() {
            testAttribution('facebook', 'cpc', 'finance_lookalike');
            setTimeout(() => testAttribution('google', 'organic', 'trading_tips'), 100);
            setTimeout(() => testAttribution('email', 'newsletter', 'weekly_market'), 200);
            setTimeout(() => testAttribution(null, null, null), 300);
            setTimeout(() => testExistingAffSub3(), 400);
        }
    </script>

    <div style="text-align: center; margin-top: 30px;">
        <button class="test-btn" onclick="runAllTests()" style="background: #059669; font-size: 18px; padding: 15px 30px;">
            üöÄ Run All Tests
        </button>
    </div>
</body>
</html>